{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | Veloce Car Rental</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'checkout.css' %}">
</head>
<body>
    <!-- Header & Navigation -->
    <header id="header">
        <div class="container navbar">
            <a href="{% url 'home' %}" class="logo">
                <h1>Veloce<span>.</span></h1>
            </a>
            <div class="mobile-toggle">
                <i class="fas fa-bars"></i>
            </div>
            <ul class="nav-links">
                <li><a href="{% url 'home' %}">Home</a></li>
                <li><a href="{% url 'car_list' %}">Cars</a></li>
                <li><a href="{% url 'service' %}">Services</a></li>
                <li><a href="{% url 'about' %}">About</a></li>
                <li><a href="{% url 'contact' %}">Contact</a></li>
            </ul>
            
            <!-- Profile Section -->
            <div class="profile-section">
                <div class="profile-dropdown">
                    <button class="profile-toggle">
                        <div class="profile-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <span class="profile-name">{{ request.user.username }}</span>
                        <i class="fas fa-chevron-down dropdown-icon"></i>
                    </button>
                    
                    <div class="dropdown-menu">
                        <a href="{% url 'profile' %}" class="dropdown-item">
                            <i class="fas fa-user-circle"></i> View Profile
                        </a>
                        <a href="#" class="dropdown-item">
                            <i class="fas fa-history"></i> Order History
                        </a>
                        <a href="{% url 'cart' %}" class="dropdown-item">
                            <i class="fas fa-shopping-cart"></i> View Order Cart
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="{% url 'logout' %}" class="dropdown-item logout-item">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Checkout Container -->
    <div class="checkout-container">
        <div class="container">
            <div class="section-title">
                <h2>Complete Your Reservation</h2>
            </div>
            <p class="section-subtitle" style="text-align: center; max-width: 700px; margin: 0 auto 2.5rem;">
                Almost there! Please review your reservation details and complete your payment to secure your vehicle.
            </p>

            <div class="checkout-content">
                <div class="checkout-steps">
                    <div class="step active" data-step="1">
                        <div class="step-number">1</div>
                        <div class="step-title">Personal Information</div>
                    </div>
                    <div class="step-divider"></div>
                    <div class="step" data-step="2">
                        <div class="step-number">2</div>
                        <div class="step-title">Payment Method</div>
                    </div>
                    <div class="step-divider"></div>
                    <div class="step" data-step="3">
                        <div class="step-number">3</div>
                        <div class="step-title">Confirmation</div>
                    </div>
                </div>

                <!-- Form POST to Django -->
                <form method="POST" action="{% url 'checkout' %}" id="checkout-form">
                    {% csrf_token %}
                    <input type="hidden" name="payment_method" id="payment_method" value="credit">

                    <div class="checkout-main">
                        <!-- Step 1: Personal Info -->
                        <div class="checkout-step active" id="step-1">
                            <div class="checkout-form">
                                <h3>Personal Information</h3>
                                <p style="color: var(--gray); margin-bottom: 1.5rem;">Please provide your personal details for the reservation.</p>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label>First Name</label>
                                        <input type="text" name="first_name" class="form-control" placeholder="Enter your first name" value="{{ request.user.first_name }}" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Last Name</label>
                                        <input type="text" name="last_name" class="form-control" placeholder="Enter your last name" value="{{ request.user.last_name }}" required>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Email Address</label>
                                        <input type="email" name="email" class="form-control" placeholder="Enter your email" value="{{ request.user.email }}" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Phone Number</label>
                                        <input type="tel" name="phone" class="form-control" placeholder="Enter your phone number" value="{{ user_profile.phone_number }}" required>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Driver's License Number</label>
                                        <input type="text" name="license_number" class="form-control" placeholder="Enter your license number" value="{{ user_profile.license_number }}" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Date of Birth</label>
                                        <input type="date" name="dob" class="form-control" value="{{ user_profile.dob }}" required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Delivery Address</label>
                                    <input type="text" name="address" class="form-control" placeholder="Street address" value="{{ user_profile.address }}" required>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label>City</label>
                                        <input type="text" name="city" class="form-control" placeholder="City" value="{{ user_profile.city }}" required>
                                    </div>
                                    <div class="form-group">
                                        <label>State/Province</label>
                                        <input type="text" name="state" class="form-control" placeholder="State/Province" value="{{ user_profile.state }}" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Postal Code</label>
                                        <input type="text" name="postal_code" class="form-control" placeholder="Postal Code" value="{{ user_profile.postal_code }}" required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="terms" required>
                                        <label for="terms">I agree to the <a href="#">terms and conditions</a> and <a href="#">privacy policy</a></label>
                                    </div>
                                </div>

                                <div class="form-actions">
                                    <button type="button" class="btn btn-outline" id="prev-step" style="display: none;">
                                        <i class="fas fa-arrow-left"></i> Previous
                                    </button>
                                    <button type="button" class="btn" id="next-step">
                                        Next Step <i class="fas fa-arrow-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Payment Method -->
                        <div class="checkout-step" id="step-2">
                            <div class="checkout-form">
                                <h3>Payment Method</h3>
                                <p style="color: var(--gray); margin-bottom: 1.5rem;">Enter your payment details to complete your reservation.</p>

                                <div class="payment-methods">
                                    <div class="payment-method active" data-method="credit">
                                        <i class="fas fa-credit-card"></i>
                                        <span>Credit Card</span>
                                    </div>
                                    <div class="payment-method" data-method="paypal">
                                        <i class="fab fa-paypal"></i>
                                        <span>PayPal</span>
                                    </div>
                                    <div class="payment-method" data-method="applepay">
                                        <i class="fab fa-apple"></i>
                                        <span>Apple Pay</span>
                                    </div>
                                </div>

                                <!-- Credit Card Form -->
                                <div class="payment-form active" id="credit-form">
                                    <div class="form-group">
                                        <label>Card Number</label>
                                        <div class="card-input">
                                            <input type="text" name="card_number" class="form-control" placeholder="XXXX XXXX XXXX XXXX" maxlength="19" required>
                                            <div class="card-type">
                                                <i class="fab fa-cc-visa"></i>
                                                <i class="fab fa-cc-mastercard"></i>
                                                <i class="fab fa-cc-amex"></i>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Expiration Date</label>
                                            <input type="text" name="exp_date" class="form-control" placeholder="MM/YY" maxlength="5" required>
                                        </div>
                                        <div class="form-group">
                                            <label>CVV</label>
                                            <input type="text" name="cvv" class="form-control" placeholder="XXX" maxlength="4" required>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Name on Card</label>
                                        <input type="text" name="card_name" class="form-control" placeholder="Enter name as it appears on card" required>
                                    </div>

                                    <div class="form-group">
                                        <div class="checkbox-group">
                                            <input type="checkbox" id="save-card" checked>
                                            <label for="save-card">Save this card for future bookings</label>
                                        </div>
                                    </div>
                                </div>

                                <!-- PayPal Form -->
                                <div class="payment-form" id="paypal-form">
                                    <div class="paypal-info">
                                        <p><i class="fab fa-paypal" style="color: #00457C; margin-right: 0.5rem;"></i> You will be redirected to PayPal to complete your payment.</p>
                                    </div>
                                </div>

                                <!-- Apple Pay Form -->
                                <div class="payment-form" id="applepay-form">
                                    <div class="applepay-info">
                                        <p><i class="fab fa-apple" style="color: #000; margin-right: 0.5rem;"></i> Complete your payment using Apple Pay on your device.</p>
                                    </div>
                                </div>

                                <div class="form-actions">
                                    <button type="button" class="btn btn-outline" id="prev-step-2">
                                        <i class="fas fa-arrow-left"></i> Previous
                                    </button>
                                    <button type="submit" class="btn" id="next-step-2">
                                        Review & Confirm <i class="fas fa-arrow-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Confirmation -->
                        <div class="checkout-step" id="step-3">
                            <div class="checkout-confirmation">
                                {% if rental_created %}
                                <div style="text-align: center; margin-bottom: 2rem;">
                                    <div style="width: 80px; height: 80px; background: rgba(76, 175, 80, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                                        <i class="fas fa-check-circle" style="font-size: 3rem; color: #4CAF50;"></i>
                                    </div>
                                    <h3 style="font-size: 1.8rem; color: var(--primary);">Reservation Confirmed!</h3>
                                    <p style="color: var(--gray);">Your reservation has been confirmed and a confirmation email has been sent.</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- CTA Section -->
    <section class="cta" style="padding: 4rem 0;">
        <div class="container">
            <h2>Need Assistance With Your Reservation?</h2>
            <p>Our customer service team is available 24/7 to help you with any questions or special requests for your rental.</p>
            <a href="tel:+12125557890" class="btn"><i class="fas fa-phone"></i> Call Us Now: +1 (212) 555-7890</a>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-grid">
                <div class="footer-col">
                    <h3>Veloce</h3>
                    <p>Premium car rental service providing luxury vehicles at competitive prices. We're committed to making your travel experience exceptional.</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>
                
                <div class="footer-col">
                    <h3>Quick Links</h3>
                    <ul class="footer-links">
                        <li><a href="{% url 'home' %}">Home</a></li>
                        <li><a href="{% url 'car_list' %}">Our Fleet</a></li>
                        <li><a href="{% url 'service' %}">Services</a></li>
                        <li><a href="#">How It Works</a></li>
                        <li><a href="#">Special Offers</a></li>
                        <li><a href="#">Contact Us</a></li>
                    </ul>
                </div>
                
                <div class="footer-col">
                    <h3>Our Services</h3>
                    <ul class="footer-links">
                        <li><a href="#">Airport Rentals</a></li>
                        <li><a href="#">Long-Term Leasing</a></li>
                        <li><a href="#">Luxury Vehicles</a></li>
                        <li><a href="#">Family Cars</a></li>
                        <li><a href="#">Road Trip Packages</a></li>
                        <li><a href="#">Special Occasion Rentals</a></li>
                        <li><a href="#">Corporate Fleet</a></li>
                    </ul>
                </div>
                
                <div class="footer-col">
                    <h3>Contact Us</h3>
                    <ul class="footer-links">
                        <li><i class="fas fa-map-marker-alt"></i> 123 Drive Street, New York, NY</li>
                        <li><i class="fas fa-phone"></i> +1 (212) 555-7890</li>
                        <li><i class="fas fa-envelope"></i> info@veloce.com</li>
                        <li><i class="fas fa-clock"></i> Mon-Sun: 8AM - 10PM</li>
                    </ul>
                </div>
            </div>
            
            <div class="copyright">
                &copy; 2023 Veloce Car Rental. All rights reserved.
            </div>
        </div>
    </footer>

    <script>
        // Header scroll effect
        window.addEventListener('scroll', function() {
            const header = document.getElementById('header');
            if (window.scrollY > 100) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
        });

        // Mobile menu toggle
        const mobileToggle = document.querySelector('.mobile-toggle');
        const navLinks = document.querySelector('.nav-links');
        
        mobileToggle.addEventListener('click', function() {
            navLinks.classList.toggle('active');
            this.innerHTML = navLinks.classList.contains('active') ? 
                '<i class="fas fa-times"></i>' : '<i class="fas fa-bars"></i>';
        });

        // Close mobile menu when clicking a link
        document.querySelectorAll('.nav-links a').forEach(link => {
            link.addEventListener('click', () => {
                navLinks.classList.remove('active');
                mobileToggle.innerHTML = '<i class="fas fa-bars"></i>';
            });
        });

        // Checkout steps functionality
        const steps = document.querySelectorAll('.step');
        const checkoutSteps = document.querySelectorAll('.checkout-step');
        let currentStep = 1;
        
        function goToStep(step) {
            // Update steps UI
            steps.forEach((s, index) => {
                const stepNum = index + 1;
                s.classList.remove('active', 'completed');
                
                if (stepNum < step) {
                    s.classList.add('completed');
                } else if (stepNum === step) {
                    s.classList.add('active');
                }
            });
            
            // Show/hide checkout steps
            checkoutSteps.forEach((cs, index) => {
                const stepNum = index + 1;
                if (stepNum === step) {
                    cs.classList.add('active');
                } else {
                    cs.classList.remove('active');
                }
            });
            
            // Update button visibility
            document.getElementById('prev-step').style.display = step > 1 ? 'inline-flex' : 'none';
            document.getElementById('prev-step-2').style.display = step > 1 ? 'inline-flex' : 'none';
            
            currentStep = step;
        }
        
        // Next button click
        document.getElementById('next-step').addEventListener('click', function() {
            // In a real implementation, this would validate the form
            const firstName = document.querySelector('#step-1 .form-control[placeholder="Enter your first name"]').value;
            const lastName = document.querySelector('#step-1 .form-control[placeholder="Enter your last name"]').value;
            const email = document.querySelector('#step-1 .form-control[placeholder="Enter your email"]').value;
            
            if (!firstName || !lastName || !email) {
                alert('Please fill in all required fields.');
                return;
            }
            
            goToStep(2);
        });
        
        // Previous button click (from step 2)
        document.getElementById('prev-step-2').addEventListener('click', function() {
            goToStep(1);
        });
        
        // Next button click (from step 2)
        document.getElementById('next-step-2').addEventListener('click', function() {
            const paymentMethod = document.querySelector('.payment-method.active').dataset.method;
            
            if (paymentMethod === 'credit') {
                const cardNumber = document.querySelector('#credit-form .form-control[placeholder="XXXX XXXX XXXX XXXX"]').value;
                const expDate = document.querySelector('#credit-form .form-control[placeholder="MM/YY"]').value;
                const cvv = document.querySelector('#credit-form .form-control[placeholder="XXX"]').value;
                const cardName = document.querySelector('#credit-form .form-control[placeholder="Enter name as it appears on card"]').value;
                
                if (!cardNumber || !expDate || !cvv || !cardName) {
                    alert('Please fill in all required payment fields.');
                    return;
                }
            }
            
            goToStep(3);
        });
        
        // Payment method selection
        document.querySelectorAll('.payment-method').forEach(method => {
            method.addEventListener('click', function() {
                document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
                this.classList.add('active');
                
                const methodType = this.dataset.method;
                document.querySelectorAll('.payment-form').forEach(form => form.classList.remove('active'));
                document.getElementById(`${methodType}-form`).classList.add('active');
            });
        });
        
        // Card number formatting
        const cardInput = document.querySelector('#credit-form .form-control[placeholder="XXXX XXXX XXXX XXXX"]');
        if (cardInput) {
            cardInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                let formattedValue = '';
                
                if (value.length > 0) {
                    formattedValue += value.substring(0, 4);
                    if (value.length > 4) {
                        formattedValue += ' ' + value.substring(4, 8);
                    }
                    if (value.length > 8) {
                        formattedValue += ' ' + value.substring(8, 12);
                    }
                    if (value.length > 12) {
                        formattedValue += ' ' + value.substring(12, 16);
                    }
                }
                
                e.target.value = formattedValue;
            });
        }
        
        // Expiration date formatting
        const expInput = document.querySelector('#credit-form .form-control[placeholder="MM/YY"]');
        if (expInput) {
            expInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 2) {
                    e.target.value = value.substring(0, 2) + '/' + value.substring(2, 4);
                } else {
                    e.target.value = value;
                }
            });
        }
        
        // Process final booking
        document.querySelector('.confirmation-actions .btn').addEventListener('click', function() {
            // In a real implementation, this would process the payment and create the booking
            alert('Your payment has been processed successfully! You will receive a confirmation email shortly with your reservation details.');
            
            // Clear cart after successful booking
            fetch( {                               ///'{  'clear_cart' }',//
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(() => {
                // Update cart count in navigation
                const cartLink = document.querySelector('.dropdown-item[href$="cart/"]');
                if (cartLink) {
                    cartLink.innerHTML = cartLink.innerHTML.replace(/\sKATEX_INLINE_OPEN\d+KATEX_INLINE_CLOSE/, '');
                }
            });
        });
        
        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>